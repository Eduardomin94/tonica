generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  image       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  wallet      Wallet?
  generations Generation[]
}

model Wallet {
  id        String       @id @default(cuid())
  userId    String       @unique
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance   Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  entries   CreditEntry[]
}

enum CreditEntryType {
  PURCHASE
  CONSUME
  REFUND
  GRANT
}

enum GenerationStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Generation {
  id         String           @id @default(cuid())
  userId     String
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  mode       String
  promptUsed String?
  status     GenerationStatus @default(PENDING)
  costCredits Int             @default(0)
  imageUrls  Json?
  error      String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([userId, createdAt])
}

model CreditEntry {
  id             String          @id @default(cuid())
  walletId        String
  wallet          Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type            CreditEntryType
  amount          Int
  idempotencyKey  String          @unique
  refType         String?
  refId           String?
  metadata        Json?
  createdAt       DateTime        @default(now())

  @@index([walletId, createdAt])
  @@index([walletId, idempotencyKey])
}
